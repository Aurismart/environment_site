<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>地圖資訊</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <style>
      :root { --brand: #02C58A; --topbar-h: 64px; }
      @font-face { font-family: 'JFOpenHuninn'; src: url('src/assets/jf-openhuninn-2.1.ttf') format('truetype'); font-display: swap; }
      html, body { height: 100%; margin: 0; }
      body { font-family: 'JFOpenHuninn', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans"; }
      .topbar { position: fixed; top: 0; left: 0; right: 0; height: var(--topbar-h); background: var(--brand); color: #fff; display: flex; align-items: center; padding: 0 20px; box-shadow: 0 2px 0 rgba(0,0,0,0.08); z-index: 1500; }
      .brand { display: flex; align-items: center; gap: 10px; margin-right: 24px; }
      .brand .title { font-size: 22px; letter-spacing: 1px; }
      .tabs { display: flex; gap: 28px; flex-wrap: wrap; margin-left: auto; justify-content: flex-end; }
      .tabs a { color: #fff; text-decoration: none; font-size: 18px; opacity: 0.95; }
      .tabs a.active { font-weight: 700; text-decoration: underline; text-underline-offset: 6px; }
      .tabs a:hover { opacity: 1; }

      #mapWrap { height: 100%; padding-top: var(--topbar-h); }
      #map { height: calc(100% - 0px); width: 100%; }
      .controls { position: absolute; z-index: 1000; top: calc(var(--topbar-h) + 10px); left: 10px; background: rgba(255,255,255,0.95); border-radius: 8px; padding: 10px 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); font-size: 14px; max-width: 420px; }
      .controls label { display: inline-block; margin-right: 6px; }
      .controls input[type="date"] { margin-right: 8px; }
      .row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin: 6px 0; }
      .row .grow { flex: 1 1 auto; min-width: 120px; }
      .muted { color: #666; }
      .count { font-weight: 600; }
      .btn { padding: 4px 10px; border-radius: 6px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
      .btn.primary { background: #2d7ef7; border-color: #2d7ef7; color: #fff; }
      .slider { width: 100%; }
      .num { width: 80px; }
      .seg { display:flex; gap:6px; }
      .seg .toggle { padding: 4px 8px; border-radius: 16px; border: 1px solid #bbb; background: #fff; cursor:pointer; }
      .seg .toggle.active { background: #02C58A; border-color:#02C58A; color:#fff; }
      .species-panel { margin-top: 6px; background: rgba(255,255,255,0.95); border-radius: 8px; padding: 8px 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
      .chk-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 4px 10px; max-height: 160px; overflow: auto; padding: 6px 2px; }
      .chk-list label { display: flex; align-items: center; gap: 6px; font-size: 13px; }
    </style>
  </head>
  <body>
    <header class="topbar">
      <div class="brand">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="#fff" aria-hidden="true"><path d="M12 3l9 8h-2v7a1 1 0 0 1-1 1h-4v-5H10v5H6a1 1 0 0 1-1-1v-7H3l9-8z"/><path d="M15.5 12.2c-.6 0-1.2.3-1.5.8a1.9 1.9 0 0 0-1.5-.8c-1 .1-1.7.9-1.7 1.9 0 1.7 3.2 3.4 3.2 3.4s3.2-1.7 3.2-3.4c0-1-.8-1.8-1.7-1.9z" fill="#ffe1e6"/></svg>
        <a href="index.html" class="title" style="color:#fff; text-decoration:none;">Aurismart</a>
      </div>
      <nav class="tabs" id="tabs">
        <a href="map.html" class="active">地圖資訊</a>
        <a href="stats.html">統計資料</a>
        <a href="about.html">關於我們</a>
      </nav>
    </header>

    <div id="mapWrap">
      <div id="map"></div>
    </div>
    <div class="controls">
      <div class="row">
        <label for="startDate">開始日期</label>
        <input class="grow" type="date" id="startDate" />
        <label for="endDate">結束日期</label>
        <input class="grow" type="date" id="endDate" />
      </div>
      <div class="row">
        <input id="timeSlider" class="slider grow" type="range" min="0" max="0" step="1" value="0" />
      </div>
      <div class="row seg" id="granularity">
        <button class="toggle" data-unit="day">天</button>
        <button class="toggle" data-unit="week">周</button>
        <button class="toggle" data-unit="month">月</button>
        <button class="toggle" data-unit="year">年</button>
      </div>
      <div class="species-panel">
        <div class="row">
          <strong>物種</strong>
          <div style="margin-left:auto; display:flex; gap:8px;">
            <button id="spSelectAll" class="btn">全選</button>
            <button id="spSelectNone" class="btn">全不選</button>
          </div>
        </div>
        <div id="speciesGroup" class="chk-list"></div>
      </div>
      <div class="species-panel">
        <div class="row">
          <strong>地點</strong>
          <div style="margin-left:auto; display:flex; gap:8px;">
            <button id="ctSelectAll" class="btn">全選</button>
            <button id="ctSelectNone" class="btn">全不選</button>
          </div>
        </div>
        <div id="cityGroup" class="chk-list"></div>
      </div>
      <div class="row" style="justify-content: flex-end; gap:10px;">
        <button id="playBtn" class="btn">播放</button>
        <button id="applyBtn" class="btn primary">套用篩選</button>
      </div>
      <div class="row">
        <label for="durationSec">播放總時長（秒）</label>
        <input id="durationSec" class="num" type="number" min="5" max="180" step="5" value="30" />
        <span class="muted">（依筆數平均分配）</span>
      </div>
      <div class="row muted">
        <span>日期：<span id="currentDate">—</span></span>
        <span>｜顯示筆數：<span id="shownCount" class="count">0</span>/<span id="totalCount">0</span></span>
      </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script>
      // ===== IndexedDB 簡易快取：把解析後資料存起來，下次直接讀 =====
      const DB_NAME = 'aurismart-cache';
      const STORE = 'datasets';
      function idbOpen(){
        return new Promise((resolve, reject)=>{
          const req = indexedDB.open(DB_NAME, 1);
          req.onupgradeneeded = ()=>{ const db=req.result; if(!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE); };
          req.onsuccess = ()=> resolve(req.result);
          req.onerror = ()=> reject(req.error);
        });
      }
      async function idbGet(key){ const db=await idbOpen(); return new Promise((resolve,reject)=>{ const tx=db.transaction(STORE,'readonly'); const st=tx.objectStore(STORE); const r=st.get(key); r.onsuccess=()=>resolve(r.result||null); r.onerror=()=>reject(r.error); }); }
      async function idbSet(key, val){ const db=await idbOpen(); return new Promise((resolve,reject)=>{ const tx=db.transaction(STORE,'readwrite'); const st=tx.objectStore(STORE); const r=st.put(val, key); r.onsuccess=()=>resolve(); r.onerror=()=>reject(r.error); }); }
      async function headMeta(url){ try{ const res=await fetch(url,{method:'HEAD',cache:'no-cache'}); return { etag: res.headers.get('etag')||'', lm: res.headers.get('last-modified')||'' }; } catch(_){ return {etag:'', lm:''}; } }
      function sameMeta(a,b){ return (a?.etag && b?.etag && a.etag===b.etag) || (a?.lm && b?.lm && a.lm===b.lm); }

      const map = L.map('map', { preferCanvas: true }).setView([23.6978, 120.9605], 7);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap 貢獻者' }).addTo(map);
      // CSV 檔案將優先讀取 asset/，若不存在則 fallback 到舊路徑
      const csvCandidates = [
        'src/assets/tbia_687f2cbd9387a60017b1b656(赤蛙).csv',
        'src/assets/tbia_687f2cbd9387a60017b1b656(赤蛙).csv',
        'tbia_687f2cbd9387a60017b1b656(赤蛙).csv'
      ];
      function toAbs(u){ try { return new URL(u, location.href).href; } catch(_) { return u; } }
      async function resolveFirstAccessible(urls){
        for (const u of urls){
          const abs = toAbs(u);
          try { const res = await fetch(abs, { method: 'HEAD', cache: 'no-cache' }); if (res.ok) return abs; } catch(_) {}
        }
        return toAbs(urls[0]);
      }
      const canvasRenderer = L.canvas({ padding: 0.5 });
      let allRows = [], filteredRows = [], dateKeys = []; let sliderIndex = 0; let timer = null; const markersLayer = L.layerGroup().addTo(map);
      let timeUnit = null; // 選擇的時間粒度：day/week/month/year 或 null
      const dom = { start: startDate, end: endDate, spGroup: document.getElementById('speciesGroup'), spAll: document.getElementById('spSelectAll'), spNone: document.getElementById('spSelectNone'), ctGroup: document.getElementById('cityGroup'), ctAll: document.getElementById('ctSelectAll'), ctNone: document.getElementById('ctSelectNone'), apply: applyBtn, play: playBtn, slider: timeSlider, duration: durationSec, curDate: currentDate, shown: shownCount, total: totalCount, gran: document.getElementById('granularity') };
      const fmtDateKey = d => `${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,'0')}-${String(d.getUTCDate()).padStart(2,'0')}`;
      const parseDateToUTC = s => { const d = new Date(s); return isNaN(d) ? null : d; };
      function clearTimer(){ if (timer){ clearTimeout(timer); clearInterval(timer); timer=null; } dom.play.textContent='播放'; }
      // 僅限台灣本島：使用主島粗略外框，並排除常見外離島（綠島、蘭嶼、小琉球、龜山島）
      function isOnTaiwanMainIsland(lat, lon){
        if(!Number.isFinite(lat)||!Number.isFinite(lon)) return false;
        const inMainBox = lat>=21.7 && lat<=25.4 && lon>=120.0 && lon<=122.1;
        if (!inMainBox) return false;
        // 排除：綠島
        if (lat>=22.60 && lat<=22.90 && lon>=121.40 && lon<=121.60) return false;
        // 排除：蘭嶼
        if (lat>=21.90 && lat<=22.20 && lon>=121.40 && lon<=121.80) return false;
        // 排除：小琉球
        if (lat>=22.30 && lat<=22.42 && lon>=120.32 && lon<=120.41) return false;
        // 排除：龜山島（近宜蘭外海）
        if (lat>=24.82 && lat<=24.90 && lon>=121.90 && lon<=122.05) return false;
        return true;
      }
      function colorForDate(date, minD, maxD){
        if (!minD || !maxD || maxD.getTime()===minD.getTime()) return '#d33';
        const t = (date - minD) / (maxD - minD); // 0..1 older->newer
        const light = 85 - Math.round(t * 45); // 85% -> 40%
        return `hsl(0, 70%, ${light}%)`;
      }
      function drawPoints(rows, minD, maxD){
        markersLayer.clearLayers();
        rows.forEach(p=>{ const fill=colorForDate(p.date, minD, maxD); L.circleMarker([p.lat,p.lon],{radius:4,color:'#a22',fillColor:fill,fillOpacity:0.9,weight:1, renderer: canvasRenderer}).bindPopup(`${p.name||'未知物種'}<br>${p.dateKey}<br>(${p.lat.toFixed(5)}, ${p.lon.toFixed(5)})`).addTo(markersLayer); });
      }
      function startOf(date, unit){ const d=new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate())); if(unit==='year') d.setUTCMonth(0,1); else if(unit==='month') d.setUTCDate(1); else if(unit==='week'){ const day=(d.getUTCDay()+6)%7; d.setUTCDate(d.getUTCDate()-day);} return d; }
      function endOf(date, unit){ const s=startOf(date,unit); const d=new Date(s); if(unit==='year') d.setUTCFullYear(d.getUTCFullYear()+1); else if(unit==='month') d.setUTCMonth(d.getUTCMonth()+1); else if(unit==='week') d.setUTCDate(d.getUTCDate()+7); else d.setUTCDate(d.getUTCDate()+1); return new Date(d.getTime()-1); }
      function filterByUnit(rows, unit, pivot){ if(!unit) return rows; const s=startOf(pivot,unit); const e=endOf(pivot,unit); return rows.filter(r=>r.date>=s && r.date<=e); }
      function normTW(s){ return (s||'').replace(/\s+/g,'').replace(/臺/g,'台'); }

      function applyFilter(){
        clearTimer();
        const startD=dom.start.value?new Date(dom.start.value+'T00:00:00Z'):null;
        const endD=dom.end.value?new Date(dom.end.value+'T23:59:59Z'):null;
        // 同步網址參數與導覽連結
        const sp = new URLSearchParams(location.search);
        if (dom.start.value) sp.set('start', dom.start.value); else sp.delete('start');
        if (dom.end.value) sp.set('end', dom.end.value); else sp.delete('end');
        // 依日期先計算可用物種與地點，移除無資料的選項
        const inDate = allRows.filter(r=>{ if(!r.date) return false; if(startD&&r.date<startD) return false; if(endD&&r.date>endD) return false; return true; });
        const spCounts = inDate.reduce((m,r)=>{ const k=r.name||''; if(!k) return m; m[k]=(m[k]||0)+1; return m; },{});
        const availableNames = Object.keys(spCounts);
        const cityCounts = inDate.reduce((m,r)=>{ const k=r.county||''; if(!k) return m; m[k]=(m[k]||0)+1; return m; },{});
        const availableCities = Object.keys(cityCounts).sort((a,b)=> cityCounts[b]-cityCounts[a] || a.localeCompare(b,'zh-Hant'));
        // 多選物種：移除舊 sp，逐一加入（僅保留仍有資料的）
        sp.delete('sp');
        const currChecked = Array.from(dom.spGroup.querySelectorAll('input[type="checkbox"]:checked')).map(i=>i.value).filter(Boolean);
        const kept = currChecked.filter(v=>availableNames.includes(v));
        kept.forEach(v=>sp.append('sp', v));
        // 多選地點
        sp.delete('city');
        const currCity = Array.from(dom.ctGroup.querySelectorAll('input[type="checkbox"]:checked')).map(i=>i.value).filter(Boolean);
        const keptCity = currCity.filter(v=>availableCities.includes(v));
        keptCity.forEach(v=>sp.append('city', v));
        history.replaceState(null,'', location.pathname + '?' + sp.toString());
        document.querySelectorAll('#tabs a').forEach(a=>{ const url=new URL(a.getAttribute('href'), location.href); url.search=sp.toString(); a.setAttribute('href', url.pathname.replace(location.pathname,'')+url.search); });

        // 依可用名單重建勾選（保留還存在的選擇）
        populateSpeciesOptions(availableNames, kept, spCounts);
        populateCityOptions(availableCities, keptCity, cityCounts);

        const sel = kept;
        const selCity = keptCity.map(normTW);
        filteredRows=allRows.filter(r=>{
          if(!r.date) return false;
          if(startD&&r.date<startD) return false;
          if(endD&&r.date>endD) return false;
          if (sel.length && !sel.includes(r.name)) return false;
          if (selCity.length){ const txt = normTW(r.placeText); if(!selCity.some(c=> txt.includes(c))) return false; }
          return true;
        });
        filteredRows.sort((a,b)=>a.date-b.date);
        // slider 與計時以「天」為單位
        const seen = new Set(); dateKeys = [];
        for (const r of filteredRows){ if (!seen.has(r.dateKey)){ seen.add(r.dateKey); dateKeys.push(r.dateKey); } }
        dom.total.textContent=String(filteredRows.length); dom.shown.textContent='0'; dom.curDate.textContent=dateKeys[0]||'—';
        dom.slider.min='0'; dom.slider.max=String(Math.max(dateKeys.length-1,0)); dom.slider.value='0'; sliderIndex=0; updateBySliderIndex();

        // 僅在套用篩選時計算全域視角一次，避免播放時視角晃動
        if (filteredRows.length){
          const latlngs = filteredRows.map(p=>[p.lat,p.lon]);
          map.fitBounds(latlngs, { padding:[20,20] });
        } else {
          map.setView([23.6978,120.9605],7);
        }
      }

      function todayStr(){ return new Date().toISOString().slice(0,10); }
      function populateSpeciesOptions(list, selectedList, counts){
        const uniq = Array.from(new Set(list.filter(Boolean)));
        uniq.sort((a,b)=> (counts?.[b]||0) - (counts?.[a]||0) || a.localeCompare(b,'zh-Hant'));
        dom.spGroup.innerHTML = '';
        uniq.forEach(n => {
          const id = 'sp_' + btoa(unescape(encodeURIComponent(n))).replace(/[^a-zA-Z0-9]/g,'');
          const lbl = document.createElement('label');
          const chk = document.createElement('input'); chk.type='checkbox'; chk.value=n; chk.id=id;
          if (selectedList && selectedList.includes(n)) chk.checked = true;
          const span = document.createElement('span'); span.textContent = `${n}（${counts?.[n]||0}）`;
          lbl.appendChild(chk); lbl.appendChild(span);
          dom.spGroup.appendChild(lbl);
        });
      }
      function populateCityOptions(list, selectedList, counts){
        dom.ctGroup.innerHTML = '';
        list.forEach(n => {
          const id = 'ct_' + btoa(unescape(encodeURIComponent(n))).replace(/[^a-zA-Z0-9]/g,'');
          const lbl = document.createElement('label');
          const chk = document.createElement('input'); chk.type='checkbox'; chk.value=n; chk.id=id;
          if (selectedList && selectedList.includes(n)) chk.checked = true;
          const span = document.createElement('span'); span.textContent = `${n}（${counts?.[n]||0}）`;
          lbl.appendChild(chk); lbl.appendChild(span);
          dom.ctGroup.appendChild(lbl);
        });
      }

      function initDatesFromQuery(){
        const sp = new URLSearchParams(location.search);
        const start = sp.get('start') || '2018-01-01';
        const end = sp.get('end') || todayStr();
        const spList = sp.getAll('sp');
        const ctList = sp.getAll('city');
        dom.start.value = start;
        dom.end.value = end;
        dom.spGroup.dataset.pref = JSON.stringify(spList);
        dom.ctGroup.dataset.pref = JSON.stringify(ctList);
        // 更新導航連結帶上參數
        const spp = new URLSearchParams(); spp.set('start', start); spp.set('end', end); spList.forEach(v=>spp.append('sp', v)); ctList.forEach(v=>spp.append('city', v));
        const search = `?${spp.toString()}`;
        document.querySelectorAll('#tabs a').forEach(a=>{ const href=a.getAttribute('href'); if(!href) return; a.setAttribute('href', href.split('?')[0]+search); });
      }
      // 粒度切換：單選，可取消
      dom.gran.addEventListener('click', (e)=>{
        const t = e.target.closest('.toggle'); if(!t) return;
        const unit = t.getAttribute('data-unit');
        if (t.classList.contains('active')){ t.classList.remove('active'); timeUnit=null; }
        else { dom.gran.querySelectorAll('.toggle').forEach(b=>b.classList.remove('active')); t.classList.add('active'); timeUnit=unit; }
        updateBySliderIndex();
      });
      // 物種全選/全不選
      dom.spAll.addEventListener('click', ()=>{ dom.spGroup.querySelectorAll('input[type="checkbox"]').forEach(ch=>ch.checked=true); });
      dom.spNone.addEventListener('click', ()=>{ dom.spGroup.querySelectorAll('input[type="checkbox"]').forEach(ch=>ch.checked=false); });
      // 地點全選/全不選
      dom.ctAll.addEventListener('click', ()=>{ dom.ctGroup.querySelectorAll('input[type="checkbox"]').forEach(ch=>ch.checked=true); });
      dom.ctNone.addEventListener('click', ()=>{ dom.ctGroup.querySelectorAll('input[type="checkbox"]').forEach(ch=>ch.checked=false); });
      function updateBySliderIndex(){
        if (!dateKeys.length){
          markersLayer.clearLayers();
          dom.curDate.textContent='—';
          dom.shown.textContent='0';
          return;
        }
        const idx = Math.min(sliderIndex, dateKeys.length-1);
        const key = dateKeys[idx];
        dom.curDate.textContent = key;

        let shown = [];
        let gradMin, gradMax;
        const pivot = new Date(key+'T00:00:00Z');

        if (!timeUnit){
          // 累積顯示：從最早到當天
          gradMin = filteredRows[0]?.date;
          gradMax = filteredRows[filteredRows.length-1]?.date;
          shown = filteredRows.filter(r => r.dateKey <= key);
        } else if (timeUnit === 'day') {
          // 當天：只顯示當日
          const s = new Date(key+'T00:00:00Z');
          const e = new Date(key+'T23:59:59Z');
          gradMin = s; gradMax = e;
          shown = filteredRows.filter(r => r.date >= s && r.date <= e);
        } else {
          // 週／月／年：從該期間第一天播到當天，並在跨期間時自動清空（drawPoints 會清理）
          const s = startOf(pivot, timeUnit);
          const e = endOf(pivot, timeUnit);
          gradMin = s; gradMax = e;
          shown = filteredRows.filter(r => r.date >= s && r.date <= pivot);
        }

        dom.shown.textContent = String(shown.length);
        drawPoints(shown, gradMin, gradMax);
      }
      dom.slider.addEventListener('input',e=>{ sliderIndex=Number(e.target.value); updateBySliderIndex(); });
      dom.play.addEventListener('click',()=>{
        if(timer){ clearTimer(); return; }
        if(!dateKeys.length) return;
        dom.play.textContent='暫停';
        const steps = Math.max(dateKeys.length - 1, 1);
        const totalMs = Math.max(5, Number(dom.duration.value)||30)*1000;
        const startTs = performance.now();
        const baseIndex = 0;
        sliderIndex = 0; dom.slider.value='0'; updateBySliderIndex();
        const tick = () => {
          if (sliderIndex >= dateKeys.length-1){ clearTimer(); return; }
          const nextIdx = sliderIndex + 1;
          const progress = (nextIdx - baseIndex) / steps;
          const target = startTs + progress * totalMs;
          const delay = Math.max(0, Math.round(target - performance.now()));
          timer = setTimeout(() => {
            sliderIndex = nextIdx;
            dom.slider.value = String(sliderIndex);
            updateBySliderIndex();
            tick();
          }, delay);
        };
        tick();
      });
      applyBtn.addEventListener('click', applyFilter);
      (async function init(){
        const csvPath = await resolveFirstAccessible(csvCandidates);
        // 優先從 IndexedDB 取，若檔案有更新再重新解析
        const metaNow = await headMeta(csvPath);
        const cacheKey = 'csv:'+csvPath;
        const cached = await idbGet(cacheKey);
        if (cached && sameMeta(metaNow, cached.meta) && Array.isArray(cached.data)){
          allRows = cached.data;
          initDatesFromQuery();
          const prefList = JSON.parse(dom.spGroup.dataset.pref || '[]');
          const prefCity = JSON.parse(dom.ctGroup.dataset.pref || '[]');
          const spCountsAll = allRows.reduce((m,r)=>{ const k=r.name||''; if(!k) return m; m[k]=(m[k]||0)+1; return m; },{});
          populateSpeciesOptions(Object.keys(spCountsAll), prefList, spCountsAll);
          const cCounts = allRows.reduce((m,r)=>{ const k=r.county||''; if(!k) return m; m[k]=(m[k]||0)+1; return m; },{});
          const cities = Object.keys(cCounts).sort((a,b)=> cCounts[b]-cCounts[a] || a.localeCompare(b,'zh-Hant'));
          populateCityOptions(cities, prefCity, cCounts);
          applyFilter();
          return;
        }

        Papa.parse(csvPath,{
          download:true,
          header:true,
          skipEmptyLines:true,
          worker:true,
          dynamicTyping:false,
          complete:(results)=>{
            const rows=Array.isArray(results.data)?results.data:[];
            const parsed=rows.map(r=>{ const lat=parseFloat(r.standardLatitude); const lon=parseFloat(r.standardLongitude); const d=r.standardDate?parseDateToUTC(r.standardDate):null; const dateKey=d?fmtDateKey(d):null; const county=r.county||''; const muni=r.municipality||''; const locality=r.locality||''; const placeText=[county,muni,locality].filter(Boolean).join(''); return {lat,lon,name:r.common_name_c,date:d,dateKey,county,municipality:muni,locality,placeText}; }).filter(p=>Number.isFinite(p.lat)&&Number.isFinite(p.lon)&&p.date&&isOnTaiwanMainIsland(p.lat,p.lon));
            allRows=parsed; // 顯示全部
            // 寫入快取
            idbSet(cacheKey, { meta: metaNow, data: allRows }).catch(()=>{});
            initDatesFromQuery();
            const prefList = JSON.parse(dom.spGroup.dataset.pref || '[]');
            const prefCity = JSON.parse(dom.ctGroup.dataset.pref || '[]');
            const spCountsAll = allRows.reduce((m,r)=>{ const k=r.name||''; if(!k) return m; m[k]=(m[k]||0)+1; return m; },{});
            populateSpeciesOptions(Object.keys(spCountsAll), prefList, spCountsAll);
            // 依全部資料建立地點（以縣市）與次數排序
            const cCounts = allRows.reduce((m,r)=>{ const k=r.county||''; if(!k) return m; m[k]=(m[k]||0)+1; return m; },{});
            const cities = Object.keys(cCounts).sort((a,b)=> cCounts[b]-cCounts[a] || a.localeCompare(b,'zh-Hant'));
            populateCityOptions(cities, prefCity, cCounts);
            applyFilter();
          },
          error:(err)=>console.error('CSV 解析失敗：',err)
        });
      })();
    </script>
  </body>
  
</html>
